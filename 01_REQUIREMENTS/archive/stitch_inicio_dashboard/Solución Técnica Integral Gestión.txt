Solución Técnica Integral: Gestión de Bienes Divisibles (Peso y Valor)Estado: Consolidación de Incidencias Críticas.Objetivo: Habilitar el flujo completo para productos de carnicería, fruver y granel.1. La Conexión: Causa y EfectoAmbos reportes se complementan para revelar la arquitectura rota del manejo de inventario no unitario.CapaHallazgo "Creación de Producto" (Causa)Hallazgo "Fallo POS" (Efecto)DatosLa base de datos guarda el stock como Integer y no sabe qué es un "gramo".Al intentar vender 0.5, el sistema redondea a 0 o 1, cobrando mal.LógicaEl toggle "Por Peso" es cosmético. No cambia la estructura del producto.El POS no sabe que el producto es pesable, así que no activa la calculadora de peso.NegocioNo existe el concepto de "Precio Base" (Precio x Kilo).El sistema cobra el precio base como si fuera precio final unitario.Conclusión: No podemos arreglar el POS sin arreglar primero el Inventario. El POS es "tonto"; solo actúa según la configuración que recibe del producto.2. Solución Conjunta (Hoja de Ruta Técnica)Esta corrección toca el núcleo del sistema. Se debe aplicar en este orden estricto:Paso A: Base de Datos (Los Cimientos)Modificaciones al Schema de Supabase.Tabla products:is_weighable (bool): true para Carne, false para Coca-Cola.measurement_unit (enum/text): 'kg', 'lb', 'g', 'und', 'lt'. (Vital para que el sistema sepa qué está restando).current_stock (numeric): Migrar de int a decimal(12,3) para soportar hasta 3 decimales (gramos).Tabla sale_items:quantity (numeric): Permitir decimales para registrar la venta de 0.250.Paso B: Backend & Lógica (El Cerebro)Ajustes en los Stores de Pinia / Composables.Lógica de Precio:Si is_weighable === true: El campo price se interpreta como Precio por Unidad de Medida (PUM).Si is_weighable === false: El campo price es Precio Facial.Cálculo Inverso (La regla de 3):Implementar función: getWeightFromCash(cashAmount, basePrice) => return cashAmount / basePrice.Paso C: Interfaz de Usuario (Los Controles)Formulario de Producto (ProductFormModal.vue):Al activar "Por Peso", OBLIGAR a seleccionar la Unidad (Kg/Lb).Cambiar el label del precio a: "Precio por [Unidad Seleccionada]".Punto de Venta (POSView.vue):Interceptar el clic en el producto.IF product.is_weighable:NO agregar al carrito directo.ABRIR WeightCalculatorModal.El modal debe permitir escribir:"500" (y seleccionar gramos).O "$5.000" (y que calcule el peso solo).3. Validación de Nuevos Fallos Potenciales (Análisis de Riesgo)Al arreglar esto, surgen nuevos escenarios de error ("Edge Cases") que debemos prevenir ahora:Fallo 1: La "Torre de Babel" de Unidades (Incongruencia Compra/Venta)Escenario: Don José compra un bulto de papa en Kilos (entra Stock: 50 Kg), pero configura el producto para vender en Libras.El Error: Si el sistema resta "1" (libra) de "50" (kilos) sin conversión, el inventario se descuadra (1 kg = 2.2 lb).Mitigación (Fase 1):Regla Estricta: La unidad de entrada (Compras) debe ser la misma unidad de salida (Ventas).UX: En la pantalla de Compras (StockEntry), mostrar la unidad configurada: "Ingresar cantidad en: LIBRAS".Fallo 2: El Decimal InfinitoEscenario: Precio Carne: $24.000/kg. Cliente pide: $500 pesos.Cálculo: 500 / 24000 = 0.020833333... kg.El Error: Si la base de datos solo acepta 2 decimales, guardará 0.02. Al hacer la reversa (0.02 * 24000), da $480. Faltan $20 pesos.Mitigación: Usar decimal.js y guardar hasta 4 decimales en cantidad, pero redondear el precio final al entero más cercano (o a la centena, ej: $500).Fallo 3: El Teclado del POSEl Error: El diseño actual del Numpad tiene un punto . pero no validamos si funciona para cantidades.Validación: Asegurar que el botón . funcione en el Modal de Peso (1.5 lb).4. Conclusión del DesarrolladorLa solución requiere refactorizar el núcleo de datos. No es solo un cambio visual.Acción Inmediata:Debemos actualizar el Modelo de Base de Datos (ERD) y los Prompts de Stitch para incluir explícitamente el campo measurement_unit y la lógica de validación de decimales. Si no hacemos esto, la aplicación no servirá para una tienda real colombiana (donde el menudeo es rey).


